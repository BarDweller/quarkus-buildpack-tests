name: Multi Platform Runner 

on: 
  workflow_dispatch:

jobs:
  integration-tests:
    strategy:
      matrix:
        project: [hello-spring]
        java: [8]
        jbang: [0.84.2]
        java-buildpack-lib-jitpack: [ "com.github.BarDweller.java-buildpack-client:buildpack-client:97f2971c4c46ea01c760de4b54a8cc2baf2d84bc" ]
        runner: [ macos-13,ubuntu-24.04 ]
    runs-on: [ "${{ matrix.runner }}" ]
    name: Test Java ${{ matrix.java }} JBang ${{ matrix.jbang }} Project ${{ matrix.project }} Runner ${{ matrix.runner }}
    steps:

      - name: Freee Disk Space for Ubuntu
        if: matrix.runner == 'ubuntu-24.04'
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: false

      - name: Podman Mac
        if: matrix.runner == 'macos-13'
        run: |
          echo "Installing Podman for Mac"
          cd /tmp
          wget -nv "https://github.com/containers/podman/releases/download/v5.3.1/podman-installer-macos-universal.pkg"
          sudo installer -pkg /tmp/podman-installer-macos-universal.pkg -target /
          export PATH=$PATH:/opt/podman/bin
          echo "/opt/podman/bin" >> $GITHUB_PATH
          podman machine init
          podman machine start
          
      - name: Podman Ubuntu
        if: matrix.runner == 'ubuntu-24.04'
        run: |
          echo "Installing Podman for ubuntu (no-op)" 

      - name: Podman info
        run: |
          echo "Podman information"
          podman info

      - name: Setup Java
        uses: actions/setup-java@v2
        with:
          java-version: ${{ matrix.java }}
          distribution: 'adopt'

      - name: Setup sdkman and jbang
        run: |
          curl -s "https://get.sdkman.io" | bash

          source "$HOME/.sdkman/bin/sdkman-init.sh"
          sdkman_auto_answer=false
          sdkman_selfupdate_enable=false

          echo "$HOME/.sdkman/bin" >> $GITHUB_PATH
          echo "sdkman_auto_answer=false" >> $GITHUB_ENV
          echo "sdkman_selfupdate_enable=false" >> $GITHUB_ENV

          sdk install jbang ${{matrix.jbang}}
          sdk default jbang ${{matrix.jbang}}
          echo "$HOME/.jbang/bin" >> $GITHUB_PATH

          echo "Dump github path"
          cat $GITHUB_PATH
          echo "Dump github env"
          cat $GITHUB_ENV

          ls -alR ~/.jbang

          echo "Dump bashrc"
          cat ~/.bashrc
          
      - name: Checkout
        uses: actions/checkout@v2.3.4
        
      - name: Build test project
        run: |
          echo Setting up to build ${{ matrix.project }} with ${{ matrix.java-buildpack-lib-jitpack}} on ${{ matrix.runner }}
          source ~/.bashrc
          export CURRENT_WORKFLOW_DEP=${{ matrix.java-buildpack-lib-jitpack }}
          export PROJECT_PATH=./test-projects/${{ matrix.project }}
          export JDK=${{ matrix.java }}
          chmod +x ./test-projects/RunTest.java
          ./test-projects/RunTest.java
